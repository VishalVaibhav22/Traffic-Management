<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ambulance Traffic Preemption System</title>
    <style>
        :root {
            --primary: #2563eb;
            --danger: #dc2626;
            --success: #16a34a;
            --warning: #ca8a04;
            --dark: #1e293b;
            --light: #f8fafc;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f1f5f9;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        header h1 {
            margin: 0;
            padding: 0 20px;
            font-size: 1.8rem;
        }
        
        .subtitle {
            color: rgba(255,255,255,0.85);
            padding: 0 20px;
            margin: 5px 0 0;
            font-size: 1rem;
            font-weight: normal;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }
        
        .control-panel, .map-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            padding: 20px;
        }
        
        .control-panel h2, .map-container h2 {
            margin-top: 0;
            color: var(--dark);
            font-size: 1.4rem;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: #1d4ed8;
        }
        
        .btn-danger {
            background-color: var(--danger);
        }
        
        .btn-danger:hover {
            background-color: #b91c1c;
        }
        
        .btn-row {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .map-container {
            position: relative;
            height: 500px;
        }
        
        .map {
            background-color: #e2e8f0;
            height: 100%;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }
        
        .legend {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background-color: rgba(255,255,255,0.9);
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            z-index: 10;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .traffic-light {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: var(--danger);
            transform: translate(-50%, -50%);
            transition: background-color 0.3s;
            z-index: 2;
        }
        
        .traffic-light.green {
            background-color: var(--success);
        }
        
        .ambulance {
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: var(--primary);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 3;
            transition: left 0.5s ease-in-out, top 0.5s ease-in-out;
        }
        
        .ambulance::after {
            content: "ðŸš‘";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
        }
        
        .road {
            position: absolute;
            background-color: #94a3b8;
            z-index: 1;
        }
        
        .status-panel {
            margin-top: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            padding: 20px;
        }
        
        .status-panel h2 {
            margin-top: 0;
            color: var(--dark);
            font-size: 1.4rem;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 10px;
        }
        
        .status-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .status-card {
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
        }
        
        .status-card h3 {
            margin-top: 0;
            font-size: 1.1rem;
            color: var(--dark);
        }
        
        .status-card p {
            margin: 5px 0;
            font-size: 0.9rem;
        }
        
        .status-card .label {
            font-weight: 500;
            color: #64748b;
        }
        
        .signal-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .signal-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .signal-item:last-child {
            border-bottom: none;
        }
        
        .signal-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
            background-color: var(--danger);
        }
        
        .signal-status.green {
            background-color: var(--success);
        }
        
        .logs {
            height: 150px;
            overflow-y: auto;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            margin-top: 15px;
        }
        
        .log-item {
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px dashed #e2e8f0;
        }
        
        .log-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .log-time {
            color: #64748b;
            margin-right: 5px;
        }
        
        .log-info {
            color: var(--primary);
        }
        
        .log-warning {
            color: var(--warning);
        }
        
        .log-error {
            color: var(--danger);
        }
        
        .preemption-zone {
            position: absolute;
            border: 2px dashed rgba(22, 163, 74, 0.5);
            border-radius: 50%;
            z-index: 1;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <header>
        <h1>Ambulance Traffic Preemption System</h1>
        <p class="subtitle">Real-time simulation of automatic traffic signal preemption for emergency vehicles</p>
    </header>
    
    <div class="container">
        <div class="dashboard">
            <div class="control-panel">
                <h2>Control Panel</h2>
                
                <div class="form-group">
                    <label for="start-point">Start Point</label>
                    <select id="start-point">
                        <option value="hospital">City Hospital</option>
                        <option value="station">Ambulance Station</option>
                        <option value="clinic">Medical Clinic</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="end-point">Destination</label>
                    <select id="end-point">
                        <option value="accident">Accident Site</option>
                        <option value="emergency">Emergency Call</option>
                        <option value="hospital2">North Hospital</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="ambulance-speed">Ambulance Speed (km/h)</label>
                    <input type="range" id="ambulance-speed" min="30" max="80" value="50" step="5">
                    <div id="speed-value">50 km/h</div>
                </div>
                
                <div class="form-group">
                    <label for="preemption-distance">Preemption Distance (meters)</label>
                    <input type="range" id="preemption-distance" min="100" max="500" value="250" step="50">
                    <div id="distance-value">250 meters</div>
                </div>
                
                <div class="btn-row">
                    <button id="start-btn" class="btn">Start Simulation</button>
                    <button id="stop-btn" class="btn btn-danger" disabled>Stop</button>
                </div>
                
                <div class="logs" id="logs">
                    <div class="log-item">
                        <span class="log-time">12:00:00</span>
                        <span class="log-info">System initialized and ready</span>
                    </div>
                </div>
            </div>
            
            <div class="map-container">
                <h2>Simulation Map</h2>
                <div class="map" id="map">
                    <!-- Map will be populated by JavaScript -->
                </div>
                
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: var(--primary)"></div>
                        <span>Ambulance</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: var(--danger)"></div>
                        <span>Red Light</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: var(--success)"></div>
                        <span>Green Light</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="border: 2px dashed rgba(22, 163, 74, 0.5); background-color: transparent"></div>
                        <span>Preemption Zone</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="status-panel">
            <h2>Status</h2>
            
            <div class="status-container">
                <div class="status-card">
                    <h3>Ambulance Status</h3>
                    <p><span class="label">Status:</span> <span id="ambulance-status">Inactive</span></p>
                    <p><span class="label">Location:</span> <span id="ambulance-location">N/A</span></p>
                    <p><span class="label">Speed:</span> <span id="current-speed">0 km/h</span></p>
                </div>
                
                <div class="status-card">
                    <h3>System Status</h3>
                    <p><span class="label">Tracking:</span> <span id="tracking-status">Inactive</span></p>
                    <p><span class="label">Preemption Distance:</span> <span id="current-distance">250 meters</span></p>
                    <p><span class="label">Active Preemptions:</span> <span id="active-preemptions">0</span></p>
                </div>
                
                <div class="status-card">
                    <h3>Route Information</h3>
                    <p><span class="label">Start:</span> <span id="route-start">N/A</span></p>
                    <p><span class="label">Destination:</span> <span id="route-end">N/A</span></p>
                    <p><span class="label">Traffic Signals:</span> <span id="signal-count">0</span></p>
                </div>
            </div>
            
            <div class="status-card" style="margin-top: 15px;">
                <h3>Nearby Traffic Signals</h3>
                <div id="signal-list" class="signal-list">
                    <!-- Will be populated by JavaScript -->
                    <div class="signal-item">
                        <div>
                            <span class="signal-status"></span>
                            <span>No signals detected</span>
                        </div>
                        <div>N/A</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Constants and configuration
        const MAP_WIDTH = 800;
        const MAP_HEIGHT = 500;
        const EARTH_RADIUS = 6371000; // meters
        
        // Class for the Ambulance Traffic Preemption System
        class AmbulanceTrafficPreemptionSystem {
            constructor() {
                this.preemptionDistance = 250; // meters
                this.ambulanceLocation = null;
                this.route = [];
                this.trafficSignals = [];
                this.activePreemptions = new Set();
                this.isTracking = false;
                this.trackingInterval = null;
                this.mapElement = document.getElementById('map');
                this.ambulanceElement = null;
                this.preemptionZoneElement = null;
                this.ambulanceSpeed = 50; // km/h
                this.simulationInterval = null;
                this.currentRouteIndex = 0;
                this.startPoint = null;
                this.endPoint = null;
                this.locationNames = {
                    'hospital': 'City Hospital',
                    'station': 'Ambulance Station',
                    'clinic': 'Medical Clinic',
                    'accident': 'Accident Site',
                    'emergency': 'Emergency Call',
                    'hospital2': 'North Hospital'
                };
                
                // Initialize UI elements
                this.initUI();
                
                // Generate predefined routes for the simulation
                this.predefinedRoutes = this.generatePredefinedRoutes();
                
                // Add log message
                this.addLog('System initialized and ready', 'info');
            }
            
            // Initialize UI elements and event listeners
            initUI() {
                // Speed slider
                const speedSlider = document.getElementById('ambulance-speed');
                const speedValue = document.getElementById('speed-value');
                
                speedSlider.addEventListener('input', () => {
                    this.ambulanceSpeed = parseInt(speedSlider.value);
                    speedValue.textContent = `${this.ambulanceSpeed} km/h`;
                    document.getElementById('current-speed').textContent = `${this.ambulanceSpeed} km/h`;
                });
                
                // Preemption distance slider
                const distanceSlider = document.getElementById('preemption-distance');
                const distanceValue = document.getElementById('distance-value');
                
                distanceSlider.addEventListener('input', () => {
                    this.preemptionDistance = parseInt(distanceSlider.value);
                    distanceValue.textContent = `${this.preemptionDistance} meters`;
                    document.getElementById('current-distance').textContent = `${this.preemptionDistance} meters`;
                    
                    // Update preemption zone if ambulance is on the map
                    if (this.preemptionZoneElement) {
                        const size = this.preemptionDistance * 2 / 1000 * 100; // Convert to px based on map scale
                        this.preemptionZoneElement.style.width = `${size}px`;
                        this.preemptionZoneElement.style.height = `${size}px`;
                        this.preemptionZoneElement.style.marginLeft = `-${size/2}px`;
                        this.preemptionZoneElement.style.marginTop = `-${size/2}px`;
                    }
                });
                
                // Start button
                document.getElementById('start-btn').addEventListener('click', () => {
                    this.startSimulation();
                });
                
                // Stop button
                document.getElementById('stop-btn').addEventListener('click', () => {
                    this.stopSimulation();
                });
                
                // Resize the map to fit the container
                window.addEventListener('resize', () => {
                    this.resizeMap();
                });
                
                // Initial map size
                this.resizeMap();
            }
            
            // Resize the map to fit the container
            resizeMap() {
                const container = document.querySelector('.map-container');
                const width = container.clientWidth - 40; // Subtract padding
                const height = container.clientHeight - 70; // Subtract heading and padding
                
                this.mapElement.style.width = `${width}px`;
                this.mapElement.style.height = `${height}px`;
            }
            
            // Generate predefined routes for different combinations of start and end points
            generatePredefinedRoutes() {
                const routes = {
                    'hospital-accident': [
                        { lat: 100, lng: 100 },
                        { lat: 200, lng: 150 },
                        { lat: 300, lng: 200 },
                        { lat: 400, lng: 250 },
                        { lat: 500, lng: 300 },
                        { lat: 600, lng: 350 }
                    ],
                    'hospital-emergency': [
                        { lat: 100, lng: 100 },
                        { lat: 150, lng: 200 },
                        { lat: 200, lng: 300 },
                        { lat: 250, lng: 400 },
                        { lat: 300, lng: 500 }
                    ],
                    'hospital-hospital2': [
                        { lat: 100, lng: 100 },
                        { lat: 200, lng: 150 },
                        { lat: 300, lng: 200 },
                        { lat: 400, lng: 250 },
                        { lat: 500, lng: 300 },
                        { lat: 600, lng: 350 },
                        { lat: 700, lng: 400 }
                    ],
                    'station-accident': [
                        { lat: 100, lng: 400 },
                        { lat: 200, lng: 350 },
                        { lat: 300, lng: 300 },
                        { lat: 400, lng: 250 },
                        { lat: 500, lng: 300 },
                        { lat: 600, lng: 350 }
                    ],
                    'station-emergency': [
                        { lat: 100, lng: 400 },
                        { lat: 150, lng: 350 },
                        { lat: 200, lng: 300 },
                        { lat: 250, lng: 350 },
                        { lat: 300, lng: 500 }
                    ],
                    'station-hospital2': [
                        { lat: 100, lng: 400 },
                        { lat: 200, lng: 350 },
                        { lat: 300, lng: 300 },
                        { lat: 400, lng: 250 },
                        { lat: 500, lng: 300 },
                        { lat: 600, lng: 350 },
                        { lat: 700, lng: 400 }
                    ],
                    'clinic-accident': [
                        { lat: 100, lng: 300 },
                        { lat: 200, lng: 250 },
                        { lat: 300, lng: 200 },
                        { lat: 400, lng: 250 },
                        { lat: 500, lng: 300 },
                        { lat: 600, lng: 350 }
                    ],
                    'clinic-emergency': [
                        { lat: 100, lng: 300 },
                        { lat: 150, lng: 250 },
                        { lat: 200, lng: 300 },
                        { lat: 250, lng: 350 },
                        { lat: 300, lng: 500 }
                    ],
                    'clinic-hospital2': [
                        { lat: 100, lng: 300 },
                        { lat: 200, lng: 250 },
                        { lat: 300, lng: 200 },
                        { lat: 400, lng: 250 },
                        { lat: 500, lng: 300 },
                        { lat: 600, lng: 350 },
                        { lat: 700, lng: 400 }
                    ]
                };
                
                return routes;
            }
            
            // Calculate route between start and end points
            calculateRoute(startPoint, endPoint) {
                this.startPoint = startPoint;
                this.endPoint = endPoint;
                
                const routeKey = `${startPoint}-${endPoint}`;
                if (this.predefinedRoutes[routeKey]) {
                    this.route = this.predefinedRoutes[routeKey];
                    this.addLog(`Calculated route from ${this.locationNames[startPoint]} to ${this.locationNames[endPoint]}`, 'info');
                    
                    // Update UI
                    document.getElementById('route-start').textContent = this.locationNames[startPoint];
                    document.getElementById('route-end').textContent = this.locationNames[endPoint];
                    
                    return true;
                } else {
                    this.addLog(`No route found from ${startPoint} to ${endPoint}`, 'error');
                    return false;
                }
            }
            
            // Generate traffic signals along the route
            generateTrafficSignals() {
                if (!this.route || this.route.length === 0) {
                    this.addLog('No route available to generate traffic signals', 'error');
                    return [];
                }
                
                const signals = [];
                
                // Place a signal at every other point except start and end
                for (let i = 1; i < this.route.length - 1; i += 2) {
                    const signalId = `signal_${signals.length + 1}`;
                    signals.push({
                        id: signalId,
                        lat: this.route[i].lat,
                        lng: this.route[i].lng,
                        status: 'red'
                    });
                }
                
                this.trafficSignals = signals;
                this.addLog(`Generated ${signals.length} traffic signals along the route`, 'info');
                
                // Update UI
                document.getElementById('signal-count').textContent = signals.length;
                
                return signals;
            }
            
            // Update ambulance location
            updateAmbulanceLocation(location) {
                this.ambulanceLocation = location;
                
                // Update UI
                document.getElementById('ambulance-location').textContent = `${Math.round(location.lat)}, ${Math.round(location.lng)}`;
                
                // Update ambulance position on map
                if (this.ambulanceElement) {
                    this.ambulanceElement.style.left = `${location.lng}px`;
                    this.ambulanceElement.style.top = `${location.lat}px`;
                    
                    // Update preemption zone position
                    if (this.preemptionZoneElement) {
                        this.preemptionZoneElement.style.left = `${location.lng}px`;
                        this.preemptionZoneElement.style.top = `${location.lat}px`;
                    }
                }
                
                // Check for nearby signals to preempt
                this.checkNearbySignals();
            }
            
            // Calculate distance between two points using Haversine formula
            calculateDistance(lat1, lng1, lat2, lng2) {
                // For simplicity in simulation, we'll use direct pixel distance instead
                const latDiff = lat2 - lat1;
                const lngDiff = lng2 - lng1;
                
                // Scale to meters (100px = 1km)
                const distance = Math.sqrt(latDiff * latDiff + lngDiff * lngDiff) * 10;
                
                return distance;
            }
            
            // Preempt traffic signal (turn it green)
            preemptTrafficSignal(signalId) {
                const signal = this.trafficSignals.find(s => s.id === signalId);
                if (!signal) return false;
                
                try {
                    // Find the signal element
                    const signalElement = document.getElementById(signalId);
                    if (signalElement) {
                        // Change color to green
                        signalElement.classList.add('green');
                        
                        // Update signal status
                        signal.status = 'green';
                        
                        // Add to active preemptions
                        this.activePreemptions.add(signalId);
                        
                        // Update UI
                        document.getElementById('active-preemptions').textContent = this.activePreemptions.size;
                        this.updateSignalList();
                        
                        this.addLog(`ðŸš¦ PREEMPTING SIGNAL ${signalId} at (${Math.round(signal.lat)}, ${Math.round(signal.lng)}) - TURNING GREEN`, 'info');
                        
                        // Schedule release after 10 seconds
                        setTimeout(() => {
                            this.releasePreemption(signalId);
                        }, 10000);
                        
                        return true;
                    }
                } catch (error) {
                    this.addLog(`Error preempting traffic signal ${signalId}: ${error.message}`, 'error');
                }
                
                return false;
            }
            
            // Release preemption on a signal
            releasePreemption(signalId) {
                if (this.activePreemptions.has(signalId)) {
                    this.activePreemptions.delete(signalId);
                    
                    // Find the signal element
                    const signalElement = document.getElementById(signalId);
                    if (signalElement) {
                        // Change color back to red
                        signalElement.classList.remove('green');
                        
                        // Update signal status
                        const signal = this.trafficSignals.find(s => s.id === signalId);
                        if (signal) {
                            signal.status = 'red';
                        }
                    }
                    
                    // Update UI
                    document.getElementById('active-preemptions').textContent = this.activePreemptions.size;
                    this.updateSignalList();
                    
                    this.addLog(`Released preemption on signal ${signalId}`, 'info');
                }
            }
            
            // Check for signals within preemption distance of ambulance
            checkNearbySignals() {
                if (!this.ambulanceLocation || !this.trafficSignals || this.trafficSignals.length === 0) {
                    return;
                }
                
                const { lat, lng } = this.ambulanceLocation;
                
                for (const signal of this.trafficSignals) {
                    // Skip if already preempted
                    if (this.activePreemptions.has(signal.id)) {
                        continue;
                    }
                    
                    // Calculate distance to ambulance
                    const distance = this.calculateDistance(lat, lng, signal.lat, signal.lng);
                    
                    // If within preemption distance, turn signal green
                    if (distance <= this.preemptionDistance) {
                        this.preemptTrafficSignal(signal.id);
                    }
                }
                
                // Update nearby signals list
                this.updateSignalList();
            }
            
            // Update the UI list of nearby signals
            updateSignalList() {
                if (!this.ambulanceLocation) {
                    return;
                }
                
                const signalListElement = document.getElementById('signal-list');
                signalListElement.innerHTML = '';
                
                const { lat, lng } = this.ambulanceLocation;
                const nearbySignals = [];
                
                for (const signal of this.trafficSignals) {
                    const distance = this.calculateDistance(lat, lng, signal.lat, signal.lng);
                    
                    if (distance <= 500) { // Show signals within 500 meters
                        nearbySignals.push({
                            id: signal.id,
                            distance: Math.round(distance),
                            preempted: this.activePreemptions.has(signal.id)
                        });
                    }
                }
                // Sort by distance
                nearbySignals.sort((a, b) => a.distance - b.distance);
                
                if (nearbySignals.length === 0) {
                    signalListElement.innerHTML = `
                        <div class="signal-item">
                            <div>
                                <span class="signal-status"></span>
                                <span>No signals detected</span>
                            </div>
                            <div>N/A</div>
                        </div>
                    `;
                    return;
                }
                
                // Add each signal to the list
                for (const signal of nearbySignals) {
                    const signalItem = document.createElement('div');
                    signalItem.className = 'signal-item';
                    
                    const statusClass = signal.preempted ? 'green' : '';
                    
                    signalItem.innerHTML = `
                        <div>
                            <span class="signal-status ${statusClass}"></span>
                            <span>${signal.id}</span>
                        </div>
                        <div>${signal.distance} m</div>
                    `;
                    
                    signalListElement.appendChild(signalItem);
                }
            }
            
            // Start the simulation
            startSimulation() {
                // Get selected start and end points
                const startPoint = document.getElementById('start-point').value;
                const endPoint = document.getElementById('end-point').value;
                
                // Calculate route
                if (!this.calculateRoute(startPoint, endPoint)) {
                    this.addLog('Failed to calculate route', 'error');
                    return;
                }
                
                // Generate traffic signals
                this.generateTrafficSignals();
                
                // Create visualization
                this.createMapVisualization();
                
                // Set initial ambulance location to start of route
                this.updateAmbulanceLocation(this.route[0]);
                
                // Start tracking
                this.isTracking = true;
                this.currentRouteIndex = 0;
                
                // Update UI status
                document.getElementById('ambulance-status').textContent = 'Active';
                document.getElementById('tracking-status').textContent = 'Active';
                document.getElementById('current-speed').textContent = `${this.ambulanceSpeed} km/h`;
                
                // Toggle buttons
                document.getElementById('start-btn').disabled = true;
                document.getElementById('stop-btn').disabled = false;
                
                // Add log
                this.addLog(`ðŸš‘ Simulation started: ${this.locationNames[startPoint]} to ${this.locationNames[endPoint]}`, 'info');
                
                // Simulate ambulance movement
                this.simulationInterval = setInterval(() => this.moveAmbulance(), 500);
            }
            
            // Move the ambulance along the route
            moveAmbulance() {
                if (!this.isTracking || this.currentRouteIndex >= this.route.length - 1) {
                    // End of route
                    if (this.currentRouteIndex >= this.route.length - 1) {
                        this.addLog(`ðŸ Ambulance arrived at destination: ${this.locationNames[this.endPoint]}`, 'info');
                        this.stopSimulation();
                    }
                    return;
                }
                
                // Move to next point in route
                this.currentRouteIndex++;
                const newLocation = this.route[this.currentRouteIndex];
                
                // Update ambulance location
                this.updateAmbulanceLocation(newLocation);
                
                // If at the end of the route, stop the simulation
                if (this.currentRouteIndex >= this.route.length - 1) {
                    this.addLog(`ðŸ Ambulance arrived at destination: ${this.locationNames[this.endPoint]}`, 'info');
                    setTimeout(() => this.stopSimulation(), 1000);
                }
            }
            
            // Stop the simulation
            stopSimulation() {
                // Clear interval
                if (this.simulationInterval) {
                    clearInterval(this.simulationInterval);
                    this.simulationInterval = null;
                }
                
                // Update tracking status
                this.isTracking = false;
                
                // Release all preemptions
                for (const signalId of this.activePreemptions) {
                    this.releasePreemption(signalId);
                }
                
                // Update UI status
                document.getElementById('ambulance-status').textContent = 'Inactive';
                document.getElementById('tracking-status').textContent = 'Inactive';
                
                // Toggle buttons
                document.getElementById('start-btn').disabled = false;
                document.getElementById('stop-btn').disabled = true;
                
                // Add log
                this.addLog('Simulation stopped', 'info');
            }
            
            // Create map visualization
            createMapVisualization() {
                // Clear existing map
                this.mapElement.innerHTML = '';
                
                // Create roads
                this.createRoads();
                
                // Create traffic signals
                this.createTrafficSignals();
                
                // Create ambulance
                this.createAmbulance();
                
                // Create preemption zone
                this.createPreemptionZone();
            }
            
            // Create road lines on the map
            createRoads() {
                if (!this.route || this.route.length < 2) return;
                
                for (let i = 0; i < this.route.length - 1; i++) {
                    const start = this.route[i];
                    const end = this.route[i + 1];
                    
                    // Calculate angle and length
                    const dx = end.lng - start.lng;
                    const dy = end.lat - start.lat;
                    const length = Math.sqrt(dx * dx + dy * dy);
                    const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                    
                    // Create road segment
                    const roadElement = document.createElement('div');
                    roadElement.className = 'road';
                    roadElement.style.width = `${length}px`;
                    roadElement.style.height = '10px';
                    roadElement.style.left = `${start.lng}px`;
                    roadElement.style.top = `${start.lat}px`;
                    roadElement.style.transformOrigin = '0 0';
                    roadElement.style.transform = `rotate(${angle}deg)`;
                    
                    this.mapElement.appendChild(roadElement);
                }
            }
            
            // Create traffic signals on the map
            createTrafficSignals() {
                if (!this.trafficSignals || this.trafficSignals.length === 0) return;
                
                for (const signal of this.trafficSignals) {
                    const signalElement = document.createElement('div');
                    signalElement.className = 'traffic-light';
                    signalElement.id = signal.id;
                    signalElement.style.left = `${signal.lng}px`;
                    signalElement.style.top = `${signal.lat}px`;
                    
                    this.mapElement.appendChild(signalElement);
                }
            }
            
            // Create ambulance marker on the map
            createAmbulance() {
                if (!this.route || this.route.length === 0) return;
                
                const ambulanceElement = document.createElement('div');
                ambulanceElement.className = 'ambulance';
                ambulanceElement.style.left = `${this.route[0].lng}px`;
                ambulanceElement.style.top = `${this.route[0].lat}px`;
                
                this.mapElement.appendChild(ambulanceElement);
                this.ambulanceElement = ambulanceElement;
            }
            
            // Create preemption zone visualization
            createPreemptionZone() {
                if (!this.route || this.route.length === 0) return;
                
                const zoneElement = document.createElement('div');
                zoneElement.className = 'preemption-zone';
                
                // Size based on preemption distance (100px = 1km)
                const size = this.preemptionDistance * 2 / 1000 * 100;
                zoneElement.style.width = `${size}px`;
                zoneElement.style.height = `${size}px`;
                zoneElement.style.left = `${this.route[0].lng}px`;
                zoneElement.style.top = `${this.route[0].lat}px`;
                zoneElement.style.marginLeft = `-${size/2}px`;
                zoneElement.style.marginTop = `-${size/2}px`;
                
                this.mapElement.appendChild(zoneElement);
                this.preemptionZoneElement = zoneElement;
            }
            
            // Add a log message
            addLog(message, type = 'info') {
                const logsElement = document.getElementById('logs');
                
                // Get current time
                const now = new Date();
                const timeString = now.toLocaleTimeString();
                
                // Create log element
                const logElement = document.createElement('div');
                logElement.className = 'log-item';
                logElement.innerHTML = `
                    <span class="log-time">${timeString}</span>
                    <span class="log-${type}">${message}</span>
                `;
                
                // Add to logs
                logsElement.appendChild(logElement);
                
                // Scroll to bottom
                logsElement.scrollTop = logsElement.scrollHeight;
            }
        }
        
        // Initialize the system when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            const atps = new AmbulanceTrafficPreemptionSystem();
        });
    </script>
</body>
</html>
